name: Monthly Report Generation

on:
  # schedule:
     #- cron: '13 1 3 * *'  # Runs on the third day of every month at 1:13 AM (UTC)
  push:
    branches:
      - "**"
jobs:
  monthly-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Run Monthly Task
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry
          poetry install
          YEAR=$(date -d "$(date +%Y-%m-01) -2 months" +%Y)
          MONTH=$(date -d "$(date +%Y-%m-01) -2 months" +%m)
          echo "The year and month of two months ago: ${YEAR}${MONTH}"
          mkdir -p reports
          poetry run python -m get_reports.get_reports --verbose --year "${YEAR}" --month "${MONTH}"
          poetry run python -m get_reports.create_review_document --verbose --input reports/records_to_review_${YEAR}_${MONTH}.json --output reports/review_${YEAR}_${MONTH}.docx
          echo "Sending email with the output file..."
          echo "Subject: Monthly Review Document" > email.txt
          echo "To: guy.babineau@gmail.com" >> email.txt
          echo "Please find the attached review document for ${YEAR}-${MONTH}." >> email.txt
          echo "" >> email.txt
          echo "Best regards," >> email.txt
          echo "Your Automation System" >> email.txt
          echo "" >> email.txt
          mutt -s "Monthly Review Document" -a reports/review_${YEAR}_${MONTH}.docx -- guy.babineau@gmail.com < email.txt
          echo "Email sent successfully."
        env:
          EBIRDAPIKEY: ${{ secrets.EBIRDAPIKEY }}